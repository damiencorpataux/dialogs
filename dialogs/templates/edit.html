{% extends "html" %}

{% block content %}

<div class="mb-5">
    <h2 class="d-inline">
        <i class="text-secondary pe-auto me-2" data-feather="film"></i>
        {{ script.name }}
    </h2>
    <span class="small text-secondary ms-3">
        &mdash;&nbsp;<strong>Metadata:</strong> {{ script.__dict__ }}
    </span>
</div>
<div class="d-flex flex-column flex-md-row gap-3 gap-md-5">
    <div>
        <strong>Current Time:</strong> <span id="time">0</span> s.
        <br>
        <video id="player" width="320" height="240" controls>
            <source src={{ url_for('api_script_video', script_id=script.name) }} type="video/mp4">
            Your browser does not support the video tag.
        </video>
    </div>
    <div class="flex-grow-1">
        <h3>Transcript</h3>
        <div id="transcript_timeline" class="mb-4" style="position: relative; height: 21px; width: 100%"></div>
        <div id="transcript_table"></div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', init);

    // Initialize UX
    function init() {
        get_transcript().then(transcript => {
            display_timeline(transcript);
            display_table(transcript);
        });
        document.addEventListener('DOMContentLoaded', adjustTableHeight);
        window.addEventListener('resize', adjustTableHeight);
    }

    // Fetch transcript from server
    async function get_transcript() {
        const script_url = "{{ url_for('api_script_transcript', script_id=script.name) }}";
        const response = await fetch(script_url);
        const transcript = await response.json();
        return transcript;
    }

    // Post transcript on server
    async function post_transcript(new_transcript) {
        const script_url = "{{ url_for('api_script_transcript_post', script_id=script.name) }}";
        const response = await fetch(script_url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(new_transcript)
        });
        const transcript = await response.json();
        return transcript;
    }

    // Populate #transcript_table with a table containing the given transcript
    function display_table(transcript) {
        let html = `
            <table class="table table-stripped table-hover mb-0">
                <thead>
                    <tr>
                        <th>id</th>
                        <th>Start</th>
                        <th>End</th>
                        <th>Text</th>
                    </tr>
                </thead>
            `;
        for (const segment of transcript) {
            html += `
                <tr data-id="${segment.id}">
                    <td data-type="id" class="text-muted">${segment.id}</td>
                    <td data-type="start">${segment.start.toFixed(3)}</td>
                    <td data-type="end">${segment.end.toFixed(3)}</td>
                    <td data-type="text">${segment.text}</td>
                </tr>`;
        }
        html += '</table>';
        document.getElementById('transcript_table').innerHTML = html;

        const segments_by_id = {};
        for (const segment of transcript) {
            segments_by_id[segment.id] = segment;
        }

        for (const span of document.querySelectorAll('#transcript_table [data-id]')) {
            span.style.cursor = 'pointer';
            span.addEventListener('click', e => {
                if (!span.getAttribute('contenteditable')) {
                    const segment = segments_by_id[span.getAttribute('data-id')];
                    document.getElementById('player').currentTime = segment.start;
                }
            });
        }
        window.segments_by_id = segments_by_id;
        window.segments_dom_table = document.querySelectorAll('#transcript_table tbody tr');

        adjustTableHeight();
        setup_editing();
    }

    // Display timeline
    function display_timeline(transcript) {
        const transcript_timeline = document.getElementById('transcript_timeline');
        transcript_timeline.innerHTML = ''; // Clear any existing content

        const totalDuration = transcript[transcript.length - 1].end;
        window.totalDuration = totalDuration;  // Store total duration globally

        const segments_by_id = {};

        transcript.forEach(segment => {
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'segment';
            segmentDiv.dataset.id = segment.id;  // Add segment ID for reference
            segmentDiv.style.position = 'absolute';  // TODO: togglable between absolute and relative (expand)
            segmentDiv.style.backgroundColor = 'var(--bs-secondary-color)';
            segmentDiv.style.height = '20px';
            segmentDiv.style.borderRight = '1px dotted black';
            segmentDiv.style.left = (segment.start / totalDuration * 100) + '%';
            segmentDiv.style.width = ((segment.end - segment.start) / totalDuration * 100) + '%';
            segmentDiv.title = `Start: ${segment.start.toFixed(3)}, End: ${segment.end.toFixed(3)}`;
            transcript_timeline.appendChild(segmentDiv);

            segments_by_id[segment.id] = segment;

            segmentDiv.style.cursor = 'pointer';
            segmentDiv.addEventListener('click', e => {
                document.getElementById('player').currentTime = segment.start;
            });
        });

        // Add the vertical line to the timeline
        const verticalLine = document.createElement('div');
        verticalLine.id = 'vertical_line';
        verticalLine.style.position = 'absolute';
        verticalLine.style.backgroundColor = 'red';
        verticalLine.style.width = '2px';
        verticalLine.style.height = '200%';
        verticalLine.style.top = '-50%';
        verticalLine.style.left = '0';
        transcript_timeline.appendChild(verticalLine);

        window.segments_by_id = segments_by_id;
        window.segments_dom_timeline = document.querySelectorAll('#transcript_timeline .segment');
    }

    // Sync segments highlighting with player time
    document.getElementById('player').addEventListener('timeupdate', function() {
        document.getElementById('time').innerText = this.currentTime.toFixed(3);

        window.segments_dom_table.forEach(row => {
            const segmentId = row.getAttribute('data-id');
            const segment = window.segments_by_id[segmentId];

            if (segment && this.currentTime >= segment.start && this.currentTime < segment.end) {
                if (!row.classList.contains('table-primary')) {
                    row.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
                }
                row.classList.add('table-primary');
            } else {
                row.classList.remove('table-primary');
            }
        });

        window.segments_dom_timeline.forEach(div => {
            const segmentId = div.dataset.id;
            const segment = window.segments_by_id[segmentId];

            if (segment && this.currentTime >= segment.start && this.currentTime < segment.end) {
                div.style.backgroundColor = 'var(--bs-info)';
            } else {
                div.style.backgroundColor = 'var(--bs-secondary-color)';
            }
        });

        // Update the position of the vertical line
        const totalDuration = window.totalDuration;
        const transcript_timeline = document.getElementById('transcript_timeline');
        const currentTimePercent = (this.currentTime / totalDuration) * 100;
        const verticalLine = document.getElementById('vertical_line');
        verticalLine.style.left = currentTimePercent + '%';
    });

    // Resize table to fit page height
    function adjustTableHeight() {
        const transcriptElement = document.getElementById('transcript_table');
        const topPosition = transcriptElement.getBoundingClientRect().top;
        const viewportHeight = window.innerHeight;
        transcriptElement.style.overflow = 'scroll';
        transcriptElement.style.height = (viewportHeight - topPosition - 25) + 'px';
    }

    // Make segments editable
    function setup_editing() {
        function transcript_from_table() {
            transcript = [];
            for (const row of window.segments_dom_table) {
                transcript.push({
                    id: parseFloat(row.querySelector('[data-type=id]').innerText),
                    start: parseFloat(row.querySelector('[data-type=start]').innerText),
                    end: parseFloat(row.querySelector('[data-type=end]').innerText),
                    text: row.querySelector('[data-type=text]').innerText
                });
            }
            return transcript;
        }

        for (const tr of window.segments_dom_table) {
            tr.addEventListener('dblclick', function() {
                tr.setAttribute('contenteditable', true);
                tr.focus();
            });
            tr.addEventListener('blur', function() {
                const save = confirm('Do you want to save changes ?');
                if (save) {
                    const actual_transcript = transcript_from_table();
                    post_transcript(actual_transcript).then(transcript => {
                        display_table(transcript);
                        display_timeline(transcript); // Also refresh the timeline
                    });
                }
                tr.setAttribute('contenteditable', false);
            });

            tr.addEventListener('keydown', function(e) {
                if (e.key == 'Escape') {
                    tr.blur();
                }
                if (e.key == 'Enter') {
                    tr.blur();
                }
            });
        }
    }
</script>

{% endblock %}
